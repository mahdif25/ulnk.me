<?php
//$time_start = microtime(true); 

if (isset($_GET['id'])) {
}else{echo 'Error in url id !' ; exit;}
include 'control/main.php';

/////////////////////////////////////////////////////////////////////

$pr_list = ["46.161.62.217:8085","185.88.36.191:8085","79.110.28.194:8085","46.161.63.39:8085","146.185.200.106:8085","146.185.200.154:8085","46.161.63.100:8085","79.110.28.198:8085","146.185.200.34:8085","185.88.36.45:8085","146.185.200.180:8085","46.161.63.199:8085","146.185.200.234:8085","46.161.63.220:8085","185.88.36.229:8085","46.161.63.135:8085","79.110.28.197:8085","79.110.28.34:8085","46.161.63.23:8085","146.185.200.41:8085","79.110.28.189:8085","79.110.28.130:8085","46.161.62.250:8085","79.110.28.149:8085","185.88.36.198:8085","146.185.200.169:8085","185.88.36.37:8085","146.185.200.228:8085","146.185.200.245:8085","79.110.28.50:8085","185.88.36.185:8085","46.161.63.228:8085","185.88.36.141:8085","46.161.62.226:8085","46.161.63.168:8085","185.88.36.220:8085","79.110.28.168:8085","79.110.28.24:8085","146.185.200.91:8085","79.110.28.234:8085","79.110.28.238:8085","185.88.36.199:8085","79.110.28.38:8085","79.110.28.103:8085","185.88.36.174:8085","46.161.62.248:8085","46.161.63.162:8085","46.161.63.92:8085","79.110.28.122:8085","79.110.28.104:8085","146.185.200.174:8085","46.161.63.205:8085","46.161.63.190:8085","79.110.28.196:8085","79.110.28.12:8085","146.185.200.88:8085","185.88.36.27:8085","46.161.62.229:8085","46.161.63.123:8085","146.185.200.187:8085","146.185.200.139:8085","79.110.28.133:8085","146.185.200.149:8085","146.185.200.48:8085","146.185.200.112:8085","79.110.28.81:8085","79.110.28.102:8085","79.110.28.232:8085","46.161.63.28:8085","79.110.28.105:8085","185.88.36.158:8085","185.88.36.232:8085","79.110.28.46:8085","185.88.36.146:8085","46.161.63.183:8085","46.161.63.182:8085","79.110.28.61:8085","46.161.63.113:8085","146.185.200.203:8085","79.110.28.229:8085","46.161.63.229:8085","46.161.63.43:8085","185.88.36.36:8085","146.185.200.185:8085","79.110.28.212:8085","79.110.28.57:8085","79.110.28.180:8085","46.161.63.45:8085","46.161.62.197:8085","46.161.63.63:8085","146.185.200.129:8085","46.161.63.157:8085","146.185.200.207:8085","46.161.63.111:8085","79.110.28.158:8085","185.88.36.41:8085","46.161.63.201:8085","79.110.28.185:8085","46.161.63.244:8085","185.88.36.78:8085","79.110.28.106:8085","46.161.63.158:8085","146.185.200.225:8085","46.161.63.225:8085","46.161.63.181:8085","146.185.200.122:8085","146.185.200.224:8085","146.185.200.155:8085","146.185.200.40:8085","46.161.63.175:8085","46.161.63.167:8085","146.185.200.218:8085","46.161.63.248:8085","46.161.63.109:8085","79.110.28.126:8085","146.185.200.12:8085","185.88.36.226:8085","79.110.28.28:8085","146.185.200.198:8085","79.110.28.131:8085","79.110.28.135:8085","46.161.63.172:8085","185.88.36.136:8085","185.88.36.99:8085","79.110.28.236:8085","146.185.200.165:8085","46.161.63.143:8085","79.110.28.200:8085","146.185.200.100:8085","185.88.36.67:8085","46.161.62.214:8085","185.88.36.57:8085","185.88.36.81:8085","146.185.200.79:8085","146.185.200.190:8085","185.88.36.200:8085","79.110.28.218:8085","146.185.200.113:8085","46.161.62.235:8085","185.88.36.90:8085","185.88.36.65:8085","46.161.63.86:8085","46.161.63.81:8085","79.110.28.224:8085","185.88.36.103:8085","185.88.36.138:8085","185.88.36.183:8085","185.88.36.110:8085","146.185.200.212:8085","46.161.63.89:8085","185.88.36.108:8085","146.185.200.148:8085","46.161.63.245:8085","46.161.62.194:8085","46.161.63.19:8085","46.161.63.148:8085","146.185.200.223:8085","79.110.28.173:8085","185.88.36.118:8085","146.185.200.102:8085","46.161.63.165:8085","46.161.63.99:8085","46.161.63.70:8085","146.185.200.173:8085","185.88.36.82:8085","79.110.28.246:8085","185.88.36.80:8085","46.161.63.184:8085","79.110.28.93:8085","46.161.63.219:8085","46.161.63.122:8085","185.88.36.15:8085","146.185.200.75:8085","146.185.200.90:8085","146.185.200.235:8085","185.88.36.19:8085","79.110.28.65:8085","79.110.28.89:8085","185.88.36.208:8085","79.110.28.48:8085","79.110.28.13:8085","46.161.63.209:8085","79.110.28.58:8085","79.110.28.123:8085","146.185.200.39:8085","46.161.63.30:8085","146.185.200.250:8085","185.88.36.214:8085","146.185.200.158:8085","146.185.200.244:8085","146.185.200.33:8085","46.161.62.216:8085","46.161.63.114:8085","79.110.28.74:8085","46.161.63.37:8085","46.161.63.134:8085","46.161.63.187:8085","79.110.28.62:8085","79.110.28.217:8085","46.161.62.241:8085","79.110.28.42:8085","146.185.200.238:8085","79.110.28.20:8085","185.88.36.72:8085","46.161.62.206:8085","46.161.63.129:8085","79.110.28.94:8085","146.185.200.209:8085","79.110.28.21:8085","185.88.36.49:8085","146.185.200.251:8085","146.185.200.49:8085","146.185.200.146:8085","46.161.62.230:8085","185.88.36.77:8085","146.185.200.226:8085","185.88.36.28:8085","146.185.200.222:8085","46.161.62.227:8085","185.88.36.143:8085","146.185.200.86:8085","46.161.63.69:8085","146.185.200.45:8085","185.88.36.233:8085","79.110.28.92:8085","79.110.28.101:8085","79.110.28.184:8085","46.161.62.249:8085","79.110.28.165:8085","79.110.28.171:8085","185.88.36.47:8085","79.110.28.242:8085","185.88.36.39:8085","79.110.28.210:8085","146.185.200.28:8085","146.185.200.65:8085","185.88.36.71:8085","185.88.36.31:8085","146.185.200.241:8085","185.88.36.69:8085","79.110.28.78:8085","79.110.28.195:8085","46.161.63.144:8085","46.161.63.130:8085","146.185.200.249:8085","79.110.28.174:8085","185.88.36.189:8085","46.161.62.200:8085","79.110.28.241:8085","79.110.28.127:8085","46.161.63.49:8085","185.88.36.211:8085","185.88.36.134:8085","185.88.36.223:8085","46.161.63.104:8085","146.185.200.85:8085","79.110.28.233:8085","146.185.200.168:8085","185.88.36.46:8085","79.110.28.40:8085","79.110.28.73:8085","185.88.36.157:8085","79.110.28.27:8085","146.185.200.125:8085","46.161.62.195:8085","79.110.28.69:8085","46.161.63.159:8085","185.88.36.88:8085","46.161.63.83:8085","79.110.28.137:8085","46.161.62.198:8085","79.110.28.154:8085","46.161.62.232:8085","46.161.63.52:8085","185.88.36.210:8085","79.110.28.146:8085","146.185.200.38:8085","185.88.36.169:8085","79.110.28.30:8085","146.185.200.89:8085","46.161.63.212:8085","46.161.63.210:8085","46.161.63.96:8085","185.88.36.95:8085","185.88.36.186:8085","46.161.63.44:8085","185.88.36.247:8085","185.88.36.217:8085","185.88.36.63:8085","46.161.63.146:8085","146.185.200.254:8085","79.110.28.219:8085","46.161.62.254:8085","79.110.28.237:8085","79.110.28.112:8085","46.161.63.217:8085","185.88.36.230:8085","185.88.36.205:8085","146.185.200.78:8085","185.88.36.187:8085","185.88.36.184:8085","185.88.36.148:8085","185.88.36.202:8085","79.110.28.156:8085","185.88.36.105:8085","146.185.200.163:8085","46.161.63.128:8085","79.110.28.63:8085","46.161.63.136:8085","185.88.36.121:8085","79.110.28.53:8085","79.110.28.18:8085","146.185.200.181:8085","185.88.36.73:8085","185.88.36.92:8085","146.185.200.116:8085","79.110.28.176:8085","46.161.63.97:8085","146.185.200.192:8085","185.88.36.66:8085","146.185.200.153:8085","146.185.200.151:8085","146.185.200.57:8085","79.110.28.193:8085","46.161.62.253:8085","146.185.200.99:8085","46.161.63.91:8085","46.161.63.163:8085","146.185.200.109:8085","46.161.63.204:8085","79.110.28.162:8085","185.88.36.113:8085","46.161.63.237:8085","79.110.28.47:8085","146.185.200.231:8085","79.110.28.113:8085","79.110.28.55:8085","146.185.200.63:8085","46.161.63.25:8085","185.88.36.241:8085","79.110.28.225:8085","46.161.63.118:8085","146.185.200.93:8085","185.88.36.123:8085","146.185.200.220:8085","46.161.63.154:8085","46.161.62.204:8085","79.110.28.108:8085","46.161.63.75:8085","185.88.36.107:8085"];
$id_list = ["1yLX8K0QKuFeJIuL9Gql8UgJ7hgSsF67aC04nwMYgt34","1H2I1fUbJ9ZL-MF0tcQdXFB3OxjBzUvBysdOi2SFsaXU","1mfaCaxPef0OaVYw-PinbjiEcLGSyHfq3jOF-ONZbn9g","1n-5aK5AODY7pLIDlujYEKFmOtl9wVY6RgULAhZB6D7E"];
$rr_p  = $pr_list[rand(0,345)] ;
$rr_id = $id_list[rand(0,3)] ;
			 
//echo $rr_p ."<br>".$rr_id  ;
//////////////////////////////////////////////////////////////////////
$idd = $_GET['id'] ;
// Prepare our SQL, preparing the SQL statement will prevent SQL injection.
$stmt = $pdo->prepare('SELECT * FROM links WHERE idd = ?');
// Bind parameters (s = string, i = int, b = blob, etc), in our case the username is a string so we use "s"
$stmt->execute([ $idd  ]);
$account = $stmt->fetch(PDO::FETCH_ASSOC);
// Check if the account exists:
if ($account) {
	//echo $account['id'];
	///////////////////////////////////////////////
	$updato = "
    UPDATE links
    SET clicks = IFNULL(clicks, 0) + 1
    WHERE id = '".$account['id']."'   ";

	$stmt2 = $pdo->prepare($updato);
	$stmt2->execute([  ]);

	///////////////////////////////////////////////
	$r1  =  generateRandomString(20);
	$r1_ =  generateRandomString(20);	
	$r2  =  generateRandomString(11);
	$r3  =  generateRandomString(3);		
	
// echo '<b>Url : </b>' . $account['url']."<br><b>Fix : </b>&rh=p_78%3A<br> <b>Asin : </b>".$account['asin']."<br><b>Fix : </b>&gclid=<br><b>R 20 : </b>".$r1.'<br><b>R 20 : </b>'.$r1_.'<br><b>R 11 : </b>'.$r2.'<br>'.'<b>Fix : </b>_'.'<br><b>R 3 : </b>'.$r3.'<br>'."<b>Fix : </b>&".'<br><b>Mass :</b>'.$account['mass'] .'<br><br>';	
$url = $account['url']."&rh=p_78%3A".$account['asin']."&gclid=".$r1.$r1_.$r2.'_'.$r3."&".$account['mass'] ;
	//echo '<br><br>'.	$url ;
}else{
	echo 'Error in url id .' ; exit;
}

//////////////////////////////////////////////////////////
$proxy = $rr_p ;//'146.185.200.254:8085';


$ch = curl_init();

curl_setopt($ch, CURLOPT_URL, 'https://docs.google.com/spreadsheets/d/'.$rr_id .'/linkdetails?id='.$rr_id .'&linkurl='.urlencode($url).'&includes_info_params=true&usp=sharing');


//curl_setopt($ch, CURLOPT_URL, 'https://docs.google.com/spreadsheets/d/1vca5WCHIYDmrGXXN6cMpads5UQW_mnD6vGpqI70JAA4/linkdetails?id=1vca5WCHIYDmrGXXN6cMpads5UQW_mnD6vGpqI70JAA4&linkurl='.urlencode($url).'&includes_info_params=true');

curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'GET');
curl_setopt($ch, CURLOPT_PROXY, $proxy);

curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10); 
curl_setopt($ch, CURLOPT_TIMEOUT, 10); //timeout in seconds
curl_setopt($ch, CURLOPT_ENCODING, 'gzip, deflate');

$headers = array();
$headers[] = 'Authority: docs.google.com';
$headers[] = 'X-Same-Domain: 1';
$headers[] = 'Sec-Ch-Ua-Mobile: ?0';
$headers[] = 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36';
$headers[] = 'Sec-Ch-Ua: \"Google Chrome\";v=\"95\", \"Chromium\";v=\"95\", \";Not A Brand\";v=\"99\"';
$headers[] = 'Sec-Ch-Ua-Platform: \"Linux\"';
$headers[] = 'Accept: */*';
$headers[] = 'Sec-Fetch-Site: same-origin';
$headers[] = 'Sec-Fetch-Mode: cors';
$headers[] = 'Sec-Fetch-Dest: empty';
$headers[] = 'Referer: https://docs.google.com/spreadsheets/d/'.$rr_id .'/edit';
$headers[] = 'Accept-Language: en-US,en;q=0.9';

curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

$result = curl_exec($ch);

//echo $result ;

if (curl_errno($ch)) {
    echo 'Error:' . curl_error($ch);
}
curl_close($ch);


$array=explode(",",$result);

if(count($array)!=0)
{
	foreach($array as $value)
	{

		if (strpos($value, 'google.com') !== false) {
			$dd = str_replace('"',"",$value);
			$dd = str_replace(']',"",$dd);
			break ;
		}

	}
}
//echo $dd ;
$json = sprintf('"%s"',$dd); # build json string
$utf8_str = json_decode ( $json, true ); # json decode
//echo $utf8_str ;	
	
header('Content-Type: application/json; charset=utf-8');
//echo json_encode($data);
//echo '{"name":"John", "age":30, "city":"New York"}' ;
echo '{"url" : "'.$utf8_str.'"}' ;
//echo $utf8_str ;
//////////////////////////////////////////////////////////////////////
function generateRandomString($length = 10) {
    $characters = '0123456789abcdefghijklmnopqrstuvwxyzQWERTYUIOPASDFGHJKLZXCVBNM';
    $charactersLength = strlen($characters);
    $randomString = '';
    for ($i = 0; $i < $length; $i++) {
        $randomString .= $characters[rand(0, $charactersLength - 1)];
    }
    return $randomString;
}
?>